<?php declare(strict_types=1);

// phpcs:disable
namespace Mammatus\Http\Server\Generated;

use Chimera\MessageCreator\NamedConstructor;
use Laminas\Diactoros\ResponseFactory;
use Psr\Http\Message\ResponseFactoryInterface;
use Mammatus\Http\Server\Web\StreamFactory;
use Mammatus\Http\Server\Web\Psr15Decorator;
use Psr\Http\Message\StreamInterface;
use FriendsOfReact\Http\Middleware\Psr15Adapter\GroupedPSR15Middleware;
use FriendsOfReact\Http\Middleware\Psr15Adapter\PSR15Middleware;
use Mammatus\Http\Server\Middleware\UnformattedContent;
use Mammatus\Http\Server\Web\Server;
use Mezzio\Helper\ServerUrlHelper;
use Psr\Http\Message\ResponseInterface;
use Chimera\ServiceBus\Tactician\ServiceBus;
use Chimera\ExecuteQuery;
use Mezzio\Helper\ServerUrlMiddleware;
use Mammatus\Http\Server\Web\ResponseTransformerMiddleware;
use Lcobucci\ContentNegotiation\ContentTypeMiddleware;
use Laminas\Stratigility\Middleware\RequestHandlerMiddleware;
use Lcobucci\ContentNegotiation\Formatter\Json;
use Lcobucci\ContentNegotiation\Formatter\StringCast;
use League\Tactician\CommandBus;
use League\Tactician\Container\ContainerLocator;
use WyriHaximus\Metrics\Tactician\CollectorMiddleware;
use WyriHaximus\Metrics\Tactician\Metrics as CollectorMiddlewareMetrics;
use Mezzio\Helper\UrlHelper;
use Mezzio\Helper\UrlHelperMiddleware;
use Mezzio\Router\Middleware\DispatchMiddleware;
use Mezzio\Router\Middleware\ImplicitHeadMiddleware;
use Mezzio\Router\Middleware\ImplicitOptionsMiddleware;
use Mezzio\Router\Middleware\MethodNotAllowedMiddleware;
use Mezzio\Router\Middleware\RouteMiddleware;
use Mezzio\Router\RouteCollector;
use Middlewares\AccessLog;
use Middlewares\ClientIp;
use Middlewares\ContentType;
use Middlewares\Expires;
use Middlewares\ResponseTime;
use Middlewares\Uuid;
use Psr\Container\ContainerInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\MiddlewareInterface;
use Psr\Log\LoggerInterface;
use React\Cache\ArrayCache;
use React\EventLoop\Loop;
use React\Http\Middleware\LimitConcurrentRequestsMiddleware;
use React\Http\Middleware\RequestBodyBufferMiddleware;
use React\Http\Middleware\StreamingRequestMiddleware;
use Mezzio\Router\FastRouteRouter;
use React\Http\HttpServer;
use Chimera\Routing\Mezzio\RouteParamsExtractor;
use Chimera\Routing\RouteParamsExtraction;
use React\Promise\PromiseInterface;
use ReactInspector\HttpMiddleware\Metrics as MiddlewareCollectorMetrics;
use ReactInspector\HttpMiddleware\MiddlewareCollector;
use Thruway\Middleware;
use WyriHaximus\HtmlCompress\Factory as HtmlCompressFactory;
use WyriHaximus\Metrics\Label;
use WyriHaximus\Metrics\Label\Name;
use WyriHaximus\Metrics\Registry;
use WyriHaximus\PSR3\CallableThrowableLogger\CallableThrowableLogger;
use WyriHaximus\PSR3\ContextLogger\ContextLogger;
use WyriHaximus\React\Http\Middleware\CssCompressMiddleware;
use WyriHaximus\React\Http\Middleware\HtmlCompressMiddleware;
use WyriHaximus\React\Http\Middleware\JsCompressMiddleware;
use WyriHaximus\React\Http\Middleware\WebrootPreloadMiddleware;
use function React\Promise\resolve;
use function WyriHaximus\iteratorOrArrayToArray;

/**
 * This class is generated by mammatus/http-server
 */
abstract class AbstractConfiguration
{
    private bool $initialized = false;
    {% for server in servers %}
    private Server $server_{{ server.vhost().nameSanitized() }};
    {% endfor %}

    /**
     * @return iterable<MiddlewareInterface>
     */
    abstract protected function middleware(): iterable;

    final public function __construct(LoggerInterface $logger, ContainerInterface $container)
    {
        $htmlCompress = HtmlCompressFactory::constructSmallest();
        \Thruway\Logging\Logger::set($logger);
        $metricsRegistry = $container->get(Registry::class);
        $metricsRegistry->counter('vhost', 'Currently active vhosts', new Name('type'))->counter(new Label('type', 'HTTP'))->incrBy({{ servers|length }});

        $namedConstructor = $container->get(NamedConstructor::class);
        $responseFactory = new ResponseFactory();
        $responseFactoryCallable = static function () use ($responseFactory): ResponseFactoryInterface {
            return $responseFactory;
        };
        $streamFactory = new StreamFactory();
        $streamFactoryCallable = static function () use ($streamFactory): StreamInterface {
            return $streamFactory->createStream();
        };

        {% for server in servers %}
        $metricsRegistry->counter('vhost', 'Currently active vhosts', new Name('type'))->counter(new Label('type', 'WebSocket'))->incrBy({{ server.realms()|length }});
        $metricsRegistry->counter('vhost_realm', 'Currently active realms per vhosts', new Name('type'), new Name('vhost'))->counter(new Label('type', 'WebSocket'), new Label('vhost', '{{ server.vhost().name() }}'))->incrBy({{ server.realms()|length }});

        $router_{{ server.vhost().nameSanitized() }} = new FastRouteRouter();
        $routeCollector_{{ server.vhost().nameSanitized() }} = new RouteCollector($router_{{ server.vhost().nameSanitized() }});
        {% for bus in server.busses() %}
        $serviceBus_{{ server.vhost().nameSanitized() }}_{{ bus.nameSanitized() }} = $container->get(WebCommandHandlerMiddlewareFactory_{{ server.vhost().nameSanitized() }}_{{ bus.nameSanitized() }}::class);
        {% endfor %}
        {% for handler in server.handlers() %}
        $routeCollector_{{ server.vhost().nameSanitized() }}->route('{{ handler.path() }}', new RequestHandlerMiddleware(new \{{ handler.handler() }}(new ExecuteQuery($serviceBus_{{ server.vhost().nameSanitized() }}_{{ handler.busSanitized() }}, $namedConstructor, \{{ handler.command() }}::class), $responseFactory)), ['{{ handler.methods()|join("', '") }}']);
        {% endfor %}
        $http_server_{{ server.vhost().nameSanitized() }} = new HttpServer(...Psr15Decorator::decorate(...[
            ...$this->middleware(),
            new LimitConcurrentRequestsMiddleware({% if server.vhost().maxConcurrentRequests() is null %}PHP_INT_MAX{% else %}{{ server.vhost().maxConcurrentRequests() }}{% endif %}),
            new StreamingRequestMiddleware(),
            new MiddlewareCollector(MiddlewareCollectorMetrics::create($metricsRegistry, new Label('vhost', '{{ server.vhost().name() }}'))),
            {% if server.realms()|length > 0 %}
                new Middleware(['/', '/ws/'], Loop::get(), $container->get(RouterFactory_{{ server.vhost().nameSanitized() }}::class)->router()),
            {% endif %}
            new RequestBodyBufferMiddleware(),
            static fn (ServerRequestInterface $request, callable $next): PromiseInterface => resolve($next($request->withAttribute('vhost', '{{ server.vhost().name() }}'))),
            {% if server.hasWebroot() %}
            new WebrootPreloadMiddleware(
                '{{ server.webroot() }}',
                new ContextLogger($logger, ['section' => 'webroot'], 'webroot'),
                new ArrayCache(), // TODO: Add support for other cache storages
            ),
            {% endif %}
            new HtmlCompressMiddleware($htmlCompress),
            new CssCompressMiddleware($htmlCompress),
            new JsCompressMiddleware($htmlCompress),
            (new GroupedPSR15Middleware())->
                withMiddleware(new ClientIp())->
{#                withMiddleware(new Uuid())->#}
                withMiddleware((new AccessLog($container->get(LoggerInterface::class)))->format('[{{ server.vhost().name() }}] %a %l %u %Dms "%r" %>s %b "%{Referer}i" "%{User-Agent}i"')->
                    ipAttribute('client-ip')->
                    context(static fn (ServerRequestInterface $request, ResponseInterface $response): array => [
                        'client-ip' => $request->getAttribute('client-ip'),
{#                        'request-id' => $request->getHeaderLine('X-Uuid'),#}
                        'request-method' => $request->getMethod(),
                        'request-protocol-version' => $request->getProtocolVersion(),
                        'response-protocol-version' => $response->getProtocolVersion(),
                        'response-status-code' => $response->getStatusCode(),
                        'response-time' => $response->getHeaderLine('X-Response-Time'),
                        'response-time-float' => \substr($response->getHeaderLine('X-Response-Time'), 0, -2),
                        'response-time-float-single-digit' => \round((float)\substr($response->getHeaderLine('X-Response-Time'), 0, -2), 1),
                        'response-time-int' => (int)\round((float)\substr($response->getHeaderLine('X-Response-Time'), 0, -2), 0),
                    ]))->
                withMiddleware(new ResponseTime())->
{#                withMiddleware(new Expires(#}
{#                    require \Composed\package('middlewares/cache')->getPath('src/expires_defaults.php')#}
{#                ))->#}
                withMiddleware(new ServerUrlMiddleware($container->get(ServerUrlHelper::class)))->
                withMiddleware(new ContentTypeMiddleware(
                    new ContentType(
                        [
                            'json' => [
                                'extension' => ['json'],
                                'mime-type' => ['application/json'],
                                'charset' => true,
                            ],
                            'html' => [
                                'extension' => ['html', 'htm'],
                                'mime-type' => ['text/html', 'application/xhtml+xml'],
                                'charset' => true,
                            ],
                            'plain' => [
                                'extension' => [],
                                'mime-type' => ['text/plain'],
                                'charset' => true,
                            ],
                        ]
                    ),
                    [
                        'application/json' => new Json(),
                        'text/html'        => new StringCast(),
                        'text/plain'       => new StringCast(),
                    ],
                    $streamFactory,
                )),
            ...$container->get('{{ server.vhost().class() }}')->middleware(),
            (new GroupedPSR15Middleware())->
                withMiddleware(new RouteMiddleware($router_{{ server.vhost().nameSanitized() }}))->
                withMiddleware(new RouteParamsExtraction($container->get(RouteParamsExtractor::class)))->
                withMiddleware(new ImplicitHeadMiddleware($router_{{ server.vhost().nameSanitized() }}, $streamFactoryCallable))->
                withMiddleware(new ImplicitOptionsMiddleware($responseFactoryCallable))->
                withMiddleware(new MethodNotAllowedMiddleware($responseFactoryCallable))->
                withMiddleware(new UrlHelperMiddleware(new UrlHelper($router_{{ server.vhost().nameSanitized() }}))),
            new UnformattedContent(),
            new PSR15Middleware(new DispatchMiddleware()),
            static fn (ServerRequestInterface $request) => new \React\Http\Message\Response(404)
        ]));
        $http_server_{{ server.vhost().nameSanitized() }}->on('error', CallableThrowableLogger::create($logger));
        $this->server_{{ server.vhost().nameSanitized() }} = new Server(
            '{{ server.vhost().name() }}',
            '0.0.0.0:{{ server.vhost().port() }}',
            $http_server_{{ server.vhost().nameSanitized() }},
        );
        {% endfor %}

        $this->initialized = true;
    }


    /**
     * @return iterable<Server>
     */
    public function servers(): iterable
    {
        if ($this->initialized === false) {
            throw new \Exception('no init yet');
        }

        {% for server in servers %}
        yield '{{ server.vhost().name() }}' => $this->server_{{ server.vhost().nameSanitized() }};
        {% endfor %}
    }
}
// phpcs:enable
